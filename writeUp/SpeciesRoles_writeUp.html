<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Marília P. Gaiarsa" />

<meta name="date" content="2020-12-29" />

<title>Opposing effects of pollinators interaction flexibility on patch occupancy</title>

<script src="SpeciesRoles_writeUp_files/header-attrs-2.1/header-attrs.js"></script>
<script src="SpeciesRoles_writeUp_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="SpeciesRoles_writeUp_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="SpeciesRoles_writeUp_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="SpeciesRoles_writeUp_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="SpeciesRoles_writeUp_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="SpeciesRoles_writeUp_files/navigation-1.1/tabsets.js"></script>
<link href="SpeciesRoles_writeUp_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="SpeciesRoles_writeUp_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Opposing effects of pollinators interaction flexibility on patch occupancy</h1>
<h4 class="author">Marília P. Gaiarsa</h4>
<h4 class="date">2020-12-29</h4>

</div>


<style>
body {
text-align: justify}
</style>
<div id="overview" class="section level1">
<h1>Overview</h1>
<p>We we examine species interaction patterns using a long-term plant-pollinator network assembly from the central valley of California. We propose three complementary ways of measuring species’ flexibility across ecological scales, and test whether interaction flexibility at different scales enables species to have higher occupancy across the landscape. We then examine which traits explain flexibility and thus, contribute indirectly to occupancy.</p>
<p>All analyses are in the analyses folder within the github repo <a href="https://github.com/Magaiarsa/intFlex">intFlex</a>. The purpose of this document is to go through the main scripts for each analysis individually. We used R (version 4.0.2), nimble (version 0.7.1), and piecewiseSEM (version 2.1.0).</p>
<p>All analyses are executable from the main.sh file, and the necessary packages from the packages.sh file.</p>
<div id="variability" class="section level2">
<h2>Variability</h2>
<p>The code to calculate variability is inside <em>/analysis/variability</em>. We calculated three measures of interaction flexibility for each species, at each site, across years: partner, role, and structural flexibility. We only considered species that were seen at least three times.</p>
<div id="partner-flexibility" class="section level3">
<h3>Partner flexibility</h3>
<p>We modified methods for calculating <span class="math inline">\(\beta\)</span>-diversity to calculate the flexibility of interaction partners for each species across years at a site (Fig. 1a of the manuscript). We use the multivariate dispersion method considering null communities (calculated in the <em>1nulls.R</em> script) to control for alpha diversity. Our null model reshuffles interactions within communities. Then, the function <em>calcBetaStatus</em> is executed in the <em>2partner.R</em> script to calculate the pairwise dissimilarity between survey years at a site, using a dissimilarity estimator that incorporates species abundances, while also accounting for unobserved species (check the <code>vegdist</code> function of the <code>vegan</code> package).</p>
<pre class="r"><code>dis &lt;- mapply(function(a, b, c, d)
    calcBetaStatus(comm= a, ## observed communities
                   status= b, ## vector of site types
                   dis.method, ## dissimilarity metric (chao)
                   nulls=c, ## null communities
                   occ=binary, ## binary or abundance weighted
                   years=d, ## calculate beta div within
                   sub=type,
                   zscore=FALSE), ## use Chase method not zscores
    a=comm$comm,
    b=comm$status,
    c= nulls,
    d= comm$comm,
    SIMPLIFY=FALSE)</code></pre>
<p>As our measure of partner flexibility, we then calculated the coefficient of variation of the dissimilarity for each species at each site, across years:</p>
<pre><code>##     Site         GenusSpecies cv.partner
## 1 Barger  Agapostemon texanus 0.03769489
## 2 Barger   Bombus melanopygus 0.09476596
## 3 Barger     Ceratina acantha 0.34105324
## 4 Barger     Halictus ligatus 0.21510592
## 5 Barger Halictus tripartitus 0.25064970
## 6 Barger     Hylaeus mesillae 0.86133723</code></pre>
</div>
<div id="motif-flexibility" class="section level3">
<h3>Motif flexibility</h3>
<p>We calculate motif flexibility in the <em>motif.R</em> script. First, we calculated species’ motif position using the <code>node_positions</code> function from the <code>bmotif</code> package for all networks (nets) included in the analysis:</p>
<pre class="r"><code>## calculating the motif position 
calc.motif &lt;- function(x) {
  node_positions(x, level=&quot;columns&quot;, 
                           #six_node = TRUE,
                           weights_method = &quot;mean_motifweights&quot;, 
                           weights_combine = &quot;mean&quot;)}

motifs.all &lt;- lapply(nets, calc.motif)</code></pre>
<p>Because weighted methods are not available for six node motifs we considered the five node motifs to be able to include weights, resulting in 46 unique node positions for each species, in each network. Each species in each network has a <span class="math inline">\(46\)</span> dimensional vector informing the frequency with which the species occurs in each position. Thus, for each species at each site, each point represents the role of species in n-dimensional motif space in a particular year, where each dimension is the frequency with which the species occurs in a particular position within a motif. We then calculated the variability in motif positions of each species (motif flexibility) as the volume of the convex hull around the points in motif space:</p>
<pre class="r"><code>## for each site and species we created a &quot;community matrix&quot; with years as rows and motif positions as columns
beta.spp &lt;- betadisper(vegdist(comu, na.rm = TRUE, method = &quot;bray&quot;), 
                group=rep(&quot;all&quot;, nrow(comu)), 
                type=&quot;centroid&quot;)

## then we measured the area of polygon
area.motif.dist &lt;- lapply(beta.spp, function(x) areapl(x$vectors))</code></pre>
</div>
<div id="structural-variability" class="section level3">
<h3>Structural variability</h3>
<p>We evaluated how much each species contributes to the maintenance of network structure. For each site and each year, we calculated how much each species contributes to network nestedness () using the , <code>nestedcontribution</code> function from the <code>bipartite</code> package (see the <em>dataPrep/dataPrep.R</em> script). We then calculated the mean and the coefficient of variation of  values for each species ate each site, across years (see the paper for details) in the <em>4nestedContr.R</em> script.</p>
<pre class="r"><code>## calculating mean and sd per species per site
contr.nodf.spp &lt;- contr.nodf %&gt;%
  group_by(GenusSpecies, Site)  %&gt;%
  summarize(cnodf.cv = cv(nestedcontribution),
            cnodf.Mean = mean(nestedcontribution, na.rm=TRUE))</code></pre>
<pre><code>##                      GenusSpecies     Site   cnodf.cv cnodf.Mean
## 1             Agapostemon texanus   Barger 0.18177193   1.790394
## 2                 Andrena candida Rominger 0.08540196   1.256604
## 3 Anthidiellum notatum robertsoni Martinez 0.32579315   2.010140
## 4               Anthophora urbana     Fong 0.15747936   1.949819
## 5               Anthophora urbana Martinez 0.16264825   1.657282
## 6               Anthophora urbana  MullerB 0.42718219   1.949952</code></pre>
</div>
</div>
<div id="occupancy" class="section level2">
<h2>Occupancy</h2>
<p>We first calculated flexibility for species that were seen at least three times in the landscape, totaling <span class="math inline">\(37\)</span> species in N=<span class="math inline">\(39\)</span> different sites. In <em>analysis/occupancy/src/initialize.R</em> are all the functions and scripts that prepare the data for the occupancy model, and the script <em>analysis/occupancy/1runModels.R</em> runs the model. To run the MCMC in order to estimate the model coefficients, we use the NIMBLE R package. Because Nimble is constantly being updated, the code below installs the version used in our analyses.</p>
<pre class="r"><code>library(devtools)
install_github(&quot;nimble-dev/nimble&quot;, ref = &quot;v0.7.1&quot;, subdir = &quot;packages/nimble&quot;)
library(nimble)</code></pre>
<p>To explore if interaction flexibility confers advantages to populations we built a model including all interaction flexibilities for all species seen at least three times across the landscape (N=<span class="math inline">\(37\)</span>). We calculated species colonization and persistence for each species at each site over <span class="math inline">\(10\)</span> years (2006-2015) using a multi-season, multi-species occupancy model. We modeled the probability of occupancy for species  at site  as a function of colonization (<span class="math inline">\(\gamma_{ij}\)</span>) and persistence (<span class="math inline">\(\phi_{ij}\)</span>), including a random intercept of species and explanatory variables for the flexibility across scales. We then calculated the average equilibrium occupancy across the landscape as <span class="math display">\[\gamma_{ij}/(1-\phi_{ij} + \gamma_{ij})\]</span></p>
<p>The code below is an excerpt from the <em>1runModels.R</em> script.</p>
<pre class="r"><code>type &lt;- &quot;all&quot;
## define params based on type of model 
ms.ms.occ &lt;- setModel(type)
  model.input &lt;- setup(type, model.input)
  ms.ms.model &lt;- nimbleModel(
    code = ms.ms.occ,
    constants = model.input$constants,
    data = model.input$data,
    inits = model.input$inits,
    check = FALSE,
    calculate = FALSE
  )
  C.model &lt;- compileNimble(ms.ms.model)
  ## configure and build mcmc
    mcmc.spec &lt;- configureMCMC(ms.ms.model,
                               print = FALSE,
                               monitors =
                                   C.model$getNodeNames(stochOnly = TRUE,
                                                        includeData = FALSE),
                               enableWAIC = TRUE)
    mcmc &lt;- buildMCMC(mcmc.spec,
                      enableWAIC = TRUE)
    C.mcmc &lt;- compileNimble(mcmc, project = ms.ms.model)
    ## run model
    ms.ms.nimble &lt;- runMCMC(C.mcmc,
                            niter = niter,
                            nchains = nchain,
                            nburnin = burnin,
                            WAIC=TRUE)
    runMCMCcheckChains(ms.ms.nimble$samples, type = type)
    ## saves output
    save(ms.ms.nimble, model.input,
         file = file.path(save.dir,
                          sprintf(&quot;ms-ms-samples-%s.Rdata&quot;,
                                  type)))</code></pre>
<p>We then look into Nimble’s output “samples” to get the values for all chains and calculate posteriors’ probability in <em>analysis/occupancy/2posteriors.R</em>.</p>
<pre class="r"><code>#ms.ms.nimble$WAIC
ms.ms.nimble$samples</code></pre>
</div>
<div id="structural-equation-models" class="section level2">
<h2>Structural equation models</h2>
<p>We used mixed model structural equation modeling (SEM) to test whether abundance, specialization, diet breath, and phenological breadth affected interaction flexibility across scales. We calculated traits from an independent data set (see supplementary information for more details). We considered all traits had a direct effect on diet breadth, as well as a direct effect on each interaction flexibility measures. We calculated interaction flexibility for each species at each site, and included random effects for site and species in our SEM. We standardized all variables included in the SEM.</p>
<p>To avoid circularity between traits and the variability measurements, for this part of the study we considered five sites for which we tracked community assembly. Since in these areas the community context is shifting, species are most likely to be variable.</p>
<p>The following code is an excerpt from the <em>analysis/variability/5piecewiseSEM.R</em> script for partner variability. For each of or interaction variability we first scaled the variables before fitting them to the model using the <code>psem</code> function, with random effect of species and site. We then we evaluated path significance using standardized coefficients.</p>
<pre class="r"><code>## fit piecewise model with random effect of species and site 
## indirect effect through rdegree, test the effect of cv
partner.var.cv = psem(
  r.degree = lme(r.degree ~ median.abund + median.days + Lecty, 
                 random = ~ 1 | Site/GenusSpecies, data = partner.path.data),
  cv.dist = lme(cv.partner ~ median.abund + median.days + r.degree + Lecty, 
                random = ~ 1 | Site/GenusSpecies, data = partner.path.data))

# Evaluate path significance 
summary(partner.var.cv)</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
