<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Marília P. Gaiarsa" />

<meta name="date" content="2020-12-30" />

<title>Opposing effects of pollinators interaction flexibility on patch occupancy</title>

<script src="SpeciesRoles_writeUp_files/header-attrs-2.1/header-attrs.js"></script>
<script src="SpeciesRoles_writeUp_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="SpeciesRoles_writeUp_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="SpeciesRoles_writeUp_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="SpeciesRoles_writeUp_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="SpeciesRoles_writeUp_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="SpeciesRoles_writeUp_files/navigation-1.1/tabsets.js"></script>
<link href="SpeciesRoles_writeUp_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="SpeciesRoles_writeUp_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Opposing effects of pollinators interaction flexibility on patch occupancy</h1>
<h4 class="author">Marília P. Gaiarsa</h4>
<h4 class="date">2020-12-30</h4>

</div>


<style>
body {
text-align: justify}
</style>
<div id="overview" class="section level1">
<h1>Overview</h1>
<p>We we examine species interaction patterns using a long-term plant-pollinator network assembly from the central valley of California. We propose three complementary ways of measuring species’ flexibility across ecological scales: partner variability (micro-scale), network role variability (meso-scale), and network structural variability (macro-scale). We then test whether interaction flexibility at different scales enables species to have higher occupancy across the landscape. Finally, we examine which traits explain flexibility and thus, contribute indirectly to occupancy.</p>
<p>All analyses are in the analyses folder within the github repo <a href="https://github.com/Magaiarsa/intFlex">intFlex</a>. The purpose of this document is to go through the main scripts for each analysis individually. We used R (version 4.0.2), nimble (version 0.7.1), and piecewiseSEM (version 2.1.0).</p>
<div id="variability" class="section level2">
<h2>Variability</h2>
<p>The code to calculate variability is inside <code>/analysis/variability</code>. We calculated three measures of interaction flexibility for each species, at each site, across years: partner, role, and structural flexibility. We only considered species that were seen at least three different years in a site, sites that were samples at least three separate years, and also networks (combinatiosn of site x year) that had at least five plants and five pollinators.</p>
<div id="partner-variability" class="section level3">
<h3>Partner variability</h3>
<p>We modified methods for calculating <span class="math inline">\(\beta\)</span>-diversity to calculate the flexibility of interaction partners for each species across years at a site (Fig. 1a of the manuscript). We use the multivariate dispersion method considering null communities (calculated in the <code>1nulls.R</code> script) to control for alpha diversity. For each species at each site, across all years, the null model reshuffles interactions to estimate the extent to which the observed dissimilarity deviated from that which would be expected under a random process. Then, the function <code>calcBetaStatus</code> is executed in the <code>2partner.R</code>. The function <code>calcBetaStatus</code> first corrects the dissimilarity values for each species at each site, then calculates the multivariate dispersion of interaction, using a dissimilarity estimator that incorporates species abundances (Chao), while also accounting for unobserved species (check the <code>vegdist</code> function of the <code>vegan</code> package).</p>
<pre class="r"><code>dis &lt;- mapply(function(a, c, d)
    calcBetaStatus(comm= a, ## observed communities
                   dis.method, ## dissimilarity metric (chao)
                   nulls=c, ## null communities calculates in the 1nulls.R script
                   occ=binary, ## false (quantitative networks)
                   zscore=zscore), ## use zscores to correct the dissimilarity values
    a=comm$comm,
    c= nulls,
    d= comm$comm,
    SIMPLIFY=FALSE)</code></pre>
<p>As our measure of partner flexibility, we then calculated the coefficient of variation of the dissimilarity for each species at each site, across years:</p>
<pre><code>##     Site         GenusSpecies cv.partner
## 1 Barger  Agapostemon texanus 0.03769489
## 2 Barger   Bombus melanopygus 0.09476596
## 3 Barger     Ceratina acantha 0.34105324
## 4 Barger     Halictus ligatus 0.21510592
## 5 Barger Halictus tripartitus 0.25064970
## 6 Barger     Hylaeus mesillae 0.86133723</code></pre>
</div>
<div id="role-variability" class="section level3">
<h3>Role variability</h3>
<p>To characterize the roles that a species can play in their networks, we employed a network motifs approach. In the <code>dataPrep/dataPrep.R</code> file we calculated the motif positions of each species at each site and year. We used the <code>node_positions</code> function from the <code>bmotif</code> package. To control for the fact that species that have more interactions tend to appear in more motif positions, we normalized the data using the mean motif weights:</p>
<pre class="r"><code>## calculating the motif position 
calc.motif &lt;- function(x) {
  node_positions(x, level=&quot;columns&quot;, 
                     six_node = FALSE,
                     weights_method = &quot;mean_motifweights&quot;, 
                     weights_combine = &quot;mean&quot;)}

motifs.all &lt;- lapply(nets, calc.motif) ## nets is the list of networks included in the analysis</code></pre>
<p>From this data, in the <code>3motifs.R</code> script we first wrangle the data so that we have a dataframe in which the columns are the motif positions, and the rows are the different years. We create one dataframe for each species at a site. We then calculate the dissimilarity in motif positions across years, for each species at each site. Thus, each point represents the role of species in n-dimensional motif space in a particular year, where each dimension is the frequency with which the species occurs in a particular position within a motif. We used the altGower index in the vegdist function to calculate dissimilarity, and then quantified the multivariate dispersion of motif positions. Finally, we calculated motif role variability as the coefficient of variation of the distance from the centroid, for each species at each site.</p>
<pre class="r"><code>## for each site and species we created a &quot;community matrix&quot; with years as rows and motif positions as columns
dis.motif &lt;- mapply(function(a)
  calcBetaStatusMotif(comm= a, ## observed communities
                      dis.method, ## dissimilarity metric
                      occ=FALSE), ## 
  a= comm.motif,
  SIMPLIFY=FALSE)</code></pre>
<p>As our measure of role flexibility, we then calculated the coefficient of variation of the dissimilarity for each species at each site, across years:</p>
<pre><code>##     Site         GenusSpecies    pca.cv
## 1 Barger  Agapostemon texanus 0.4456127
## 2 Barger   Bombus melanopygus 0.4330127
## 3 Barger     Ceratina acantha 0.8075050
## 4 Barger     Halictus ligatus 0.6076791
## 5 Barger Halictus tripartitus 0.3358022
## 6 Barger     Hylaeus mesillae 0.2901273</code></pre>
</div>
<div id="structural-variability" class="section level3">
<h3>Structural variability</h3>
<p>We evaluated how much each species contributes to the maintenance of network structure. For each site and each year, we calculated how much each species contributes to network nestedness () using the , <code>nestedcontribution</code> function from the <code>bipartite</code> package (see the <code>dataPrep/dataPrep.R</code> script). We then calculated the mean and the coefficient of variation of  values for each species ate each site, across years in the <code>4nestedContr.R</code> script.</p>
<pre><code>##                      GenusSpecies     Site   cnodf.cv
## 1             Agapostemon texanus   Barger 0.18177193
## 2                 Andrena candida Rominger 0.08540196
## 3 Anthidiellum notatum robertsoni Martinez 0.32579315
## 4               Anthophora urbana     Fong 0.15747936
## 5               Anthophora urbana Martinez 0.16264825
## 6               Anthophora urbana  MullerB 0.42718219</code></pre>
</div>
</div>
<div id="occupancy" class="section level2">
<h2>Occupancy</h2>
<p>We used a multi-season, multi-species occupancy model to test the effect of each interaction flexibility metric on species’ colonization and persistence in the landscape. In <code>analysis/occupancy/src/initialize.R</code> are all the functions and scripts that prepare the data for the occupancy model, and the script <code>analysis/occupancy/1runModels.R</code> runs the model. To run the MCMC in order to estimate the model coefficients, we use the NIMBLE R package. Because Nimble is constantly being updated, the code below installs the version used in our analyses.</p>
<pre class="r"><code>library(devtools)
install_github(&quot;nimble-dev/nimble&quot;, ref = &quot;v0.7.1&quot;, subdir = &quot;packages/nimble&quot;)
library(nimble)</code></pre>
<p>We modeled the probability of occupancy for species  at site  as a function of colonization (<span class="math inline">\(\gamma_{ij}\)</span>) and persistence (<span class="math inline">\(\phi_{ij}\)</span>), including a random intercept of species and explanatory variables for the flexibility across scales. We then calculated the average equilibrium occupancy across the landscape as <span class="math display">\[\gamma_{ij}/(1-\phi_{ij} + \gamma_{ij})\]</span></p>
<p>The code below is an excerpt from the <em>1runModels.R</em> script.</p>
<pre class="r"><code>type &lt;- &quot;all&quot;
## define params based on type of model 
ms.ms.occ &lt;- setModel(type)
  model.input &lt;- setup(type, model.input)
  ms.ms.model &lt;- nimbleModel(
    code = ms.ms.occ,
    constants = model.input$constants,
    data = model.input$data,
    inits = model.input$inits,
    check = FALSE,
    calculate = FALSE
  )
  C.model &lt;- compileNimble(ms.ms.model)
  ## configure and build mcmc
    mcmc.spec &lt;- configureMCMC(ms.ms.model,
                               print = FALSE,
                               monitors =
                                   C.model$getNodeNames(stochOnly = TRUE,
                                                        includeData = FALSE),
                               enableWAIC = TRUE)
    mcmc &lt;- buildMCMC(mcmc.spec,
                      enableWAIC = TRUE)
    C.mcmc &lt;- compileNimble(mcmc, project = ms.ms.model)
    ## run model
    ms.ms.nimble &lt;- runMCMC(C.mcmc,
                            niter = niter,
                            nchains = nchain,
                            nburnin = burnin,
                            WAIC=TRUE)
    runMCMCcheckChains(ms.ms.nimble$samples, type = type)
    ## saves output
    save(ms.ms.nimble, model.input,
         file = file.path(save.dir,
                          sprintf(&quot;ms-ms-samples-%s.Rdata&quot;,
                                  type)))</code></pre>
<p>We then look into Nimble’s output “samples” to get the values for all chains and calculate posteriors’ probability in <code>analysis/occupancy/2posteriors.R</code>. In this script we create the Figure 3 from the paper, and also the posterior tables with the confidence intervals.</p>
</div>
<div id="structural-equation-models" class="section level2">
<h2>Structural equation models</h2>
<p>We used mixed model structural equation modeling (SEM) to test whether abundance, specialization, diet breath, body size, and phenological breadth affected interaction flexibility across scales. We calculated traits from an independent data set (see supplementary information for more details). We considered all traits had a direct effect on diet breadth, as well as a direct effect on each interaction flexibility measures. We calculated interaction flexibility for each species at each site, and included random effects for site and species in our SEM.</p>
<p>To avoid circularity between traits and the variability measurements, for this part of the study we considered five sites for which we tracked community assembly. Since in these areas the community context is shifting, species are most likely to be variable.</p>
<p>The following code is an excerpt from the <em>analysis/variability/5piecewiseSEM.R</em> script for partner variability. For each of or interaction variability we first scaled the variables before fitting them to the model using the <code>psem</code> function, with random effect of species and site. We then we evaluated path significance using standardized coefficients.</p>
<pre class="r"><code>## fit piecewise model with random effect of species and site 
## indirect effect through rdegree, test the effect of cv
partner.var.cv = psem(
  r.degree = lme(r.degree ~ median.abund + median.days + Lecty + MeanITD,
                 random = ~ 1 | Site/GenusSpecies,
                 data = path.variables$partner),
  cv.dist = lme(cv.partner ~ median.abund + median.days+ r.degree  + Lecty + MeanITD,
                random = ~ 1 | Site/GenusSpecies,
                data = path.variables$partner)) 

## To plot
export_graph(plot(partner.var.cv, return = TRUE), 
               file_name = file.path(s.path.fig,&quot;path_MeanPartner.pdf&quot;),file_type = &quot;pdf&quot;)</code></pre>
<p>Below is the ugly plot provided buy the package, which we then refined in Inkscape to make the Supplementary Figure.</p>
<div class="figure">
<img src="/Users/magaiarsa/Downloads/path_CVpartner.png" alt="A caption" width="70%" />
<p class="caption">
A caption
</p>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
