---
title: "Opposing effects of pollinators interaction flexibility on patch occupancy"
author: "Marília P. Gaiarsa"
date: "`r Sys.Date()`"
output:
  html_document: 
    self_contained: no
  pdf_document: default
  linkcolor: blue
header-includes: \usepackage{float}
geometry: "left=3cm,right=3cm,top=2cm,bottom=2cm"
---

<style>
body {
text-align: justify}
</style>

# Overview 
We we examine species interaction patterns using a long-term plant-pollinator network assembly from the central valley of California. We propose three complementary ways of measuring species' flexibility across ecological scales: partner variability (micro-scale), network role variability (meso-scale), and network structural variability (macro-scale). We then test whether interaction flexibility at different scales enables species to have higher occupancy across the landscape. Finally, we examine which traits explain flexibility and thus, contribute indirectly to occupancy. 

All analyses are in the analyses folder within the github repo [intFlex](https://github.com/Magaiarsa/intFlex). The purpose of this document is to go through the main scripts for each analysis individually. We used R (version 4.0.2), nimble (version 0.7.1), and piecewiseSEM (version 2.1.0).

## Variability 
The code to calculate variability is inside `/analysis/variability`. We calculated three measures of interaction flexibility for each species, at each site, across years: partner, role, and structural flexibility. We only considered species that were seen at least three different years in a site, sites that were samples at least three separate years, and also networks (combinatiosn of site x year) that had at least five plants and five pollinators. 

### Partner variability
We modified methods for calculating $\beta$-diversity to calculate the flexibility of interaction partners for each species across years at a site (Fig. 1a of the manuscript). We use the multivariate dispersion method considering null communities (calculated in the `1nulls.R` script) to control for alpha diversity. For each species at each site, across all years, the null model reshuffles interactions to estimate the extent to which the observed dissimilarity deviated from that which would be expected under a random process. Then, the function `calcBetaStatus` is executed in the `2partner.R`. The function `calcBetaStatus` first corrects the dissimilarity values for each species at each site, then calculates the multivariate dispersion of interaction, using a dissimilarity estimator that incorporates species abundances (Chao), while also accounting for unobserved species (check the `vegdist` function of the `vegan` package). 

```{r, eval = FALSE}
dis <- mapply(function(a, c, d)
    calcBetaStatus(comm= a, ## observed communities
                   dis.method, ## dissimilarity metric (chao)
                   nulls=c, ## null communities calculates in the 1nulls.R script
                   occ=binary, ## false (quantitative networks)
                   zscore=zscore), ## use zscores to correct the dissimilarity values
    a=comm$comm,
    c= nulls,
    d= comm$comm,
    SIMPLIFY=FALSE)
```

As our measure of partner flexibility, we then calculated the coefficient of variation of the dissimilarity for each species at each site, across years:

```{r, echo=FALSE, message=FALSE}
load("~/Dropbox/speciesRoles/analysis/variability/saved/partner.RData")
head(partner.var[,c(1,2,3)])
```

### Role variability
To characterize the roles that a species can play in their networks, we employed a network motifs approach. In the `dataPrep/dataPrep.R` file we calculated the motif positions of each species at each site and year. We used the  `node_positions` function from the `bmotif` package. To control for the fact that species that have more interactions tend to appear in more motif positions, we normalized the data using the mean motif weights: 

```{r, eval=FALSE}
## calculating the motif position 
calc.motif <- function(x) {
  node_positions(x, level="columns", 
                     six_node = FALSE,
                     weights_method = "mean_motifweights", 
                     weights_combine = "mean")}

motifs.all <- lapply(nets, calc.motif) ## nets is the list of networks included in the analysis
```

From this data, in the `3motifs.R` script we first wrangle the data so that we have a dataframe in which the columns are the motif positions, and the rows are the different years. We create one dataframe for  each species at a site. We then calculate the dissimilarity in motif positions across years, for each species at each site. Thus, each point represents the role of species in n-dimensional motif space in a particular year, where each dimension is the frequency with which the species occurs in a particular position within a motif. We used the altGower index in the vegdist function to calculate dissimilarity, and then quantified the multivariate dispersion of motif positions. Finally, we calculated motif role variability as the coefficient of variation of the distance from the centroid, for each species at each site.


```{r, eval=FALSE}
## for each site and species we created a "community matrix" with years as rows and motif positions as columns
dis.motif <- mapply(function(a)
  calcBetaStatusMotif(comm= a, ## observed communities
                      dis.method, ## dissimilarity metric
                      occ=FALSE), ## 
  a= comm.motif,
  SIMPLIFY=FALSE)
````

As our measure of role flexibility, we then calculated the coefficient of variation of the dissimilarity for each species at each site, across years:

```{r, echo=FALSE, message=FALSE}
load("~/Dropbox/speciesRoles/analysis/variability/saved/roleQ.RData")
head(pca.var[,c(1,2,3)])
```

### Structural variability
We evaluated how much each species contributes to the maintenance of network structure. For each site and each year, we calculated how much each species contributes to network nestedness (\textit{cnodf}) using the , `nestedcontribution` function from the `bipartite` package (see the `dataPrep/dataPrep.R` script). We then calculated the mean and the coefficient of variation of \textit{cnodf} values for each species ate each site, across years in the `4nestedContr.R` script.

```{r, echo=FALSE, message=FALSE}
load("/Users/magaiarsa/Dropbox/speciesRoles/analysis/variability/saved/cnodf.RData")
head(cnodf.var[!is.na(cnodf.var$cnodf.cv),c(1:3)])
```

## Occupancy
We used a multi-season, multi-species occupancy model  to test the effect of each interaction flexibility metric on species’ colonization and persistence in the landscape. In `analysis/occupancy/src/initialize.R ` are all the functions and scripts that prepare the data for the occupancy model, and the script  `analysis/occupancy/1runModels.R` runs the model. To run the MCMC in order to estimate the model coefficients, we use the NIMBLE R package. Because Nimble is constantly being updated, the code below installs the version used in our analyses. 

```{r, eval=FALSE}
library(devtools)
install_github("nimble-dev/nimble", ref = "v0.7.1", subdir = "packages/nimble")
library(nimble)
```

We modeled the probability of occupancy for species \textit{i} at site \textit{j} as a function of colonization ($\gamma_{ij}$) and persistence ($\phi_{ij}$), including a random intercept of species and explanatory variables for the flexibility across scales.  We then calculated the average equilibrium occupancy across the landscape as $$\gamma_{ij}/(1-\phi_{ij} + \gamma_{ij})$$

The code below is an excerpt from the *1runModels.R* script. 

```{r, eval=FALSE}
type <- "all"
## define params based on type of model 
ms.ms.occ <- setModel(type)
  model.input <- setup(type, model.input)
  ms.ms.model <- nimbleModel(
    code = ms.ms.occ,
    constants = model.input$constants,
    data = model.input$data,
    inits = model.input$inits,
    check = FALSE,
    calculate = FALSE
  )
  C.model <- compileNimble(ms.ms.model)
  ## configure and build mcmc
    mcmc.spec <- configureMCMC(ms.ms.model,
                               print = FALSE,
                               monitors =
                                   C.model$getNodeNames(stochOnly = TRUE,
                                                        includeData = FALSE),
                               enableWAIC = TRUE)
    mcmc <- buildMCMC(mcmc.spec,
                      enableWAIC = TRUE)
    C.mcmc <- compileNimble(mcmc, project = ms.ms.model)
    ## run model
    ms.ms.nimble <- runMCMC(C.mcmc,
                            niter = niter,
                            nchains = nchain,
                            nburnin = burnin,
                            WAIC=TRUE)
    runMCMCcheckChains(ms.ms.nimble$samples, type = type)
    ## saves output
    save(ms.ms.nimble, model.input,
         file = file.path(save.dir,
                          sprintf("ms-ms-samples-%s.Rdata",
                                  type)))
```

We then look into Nimble's output "samples" to get the values for all chains and calculate posteriors' probability in `analysis/occupancy/2posteriors.R`. In this script we create the Figure 3 from the paper, and also the posterior tables with the confidence intervals. 


## Structural equation models 
We used mixed model structural equation modeling (SEM) to test whether abundance, specialization, diet breath, body size, and phenological breadth affected interaction flexibility across scales. We calculated traits from an independent data set (see supplementary information for more details). We considered all traits had a direct effect on diet breadth, as well as a direct effect on each interaction flexibility measures. We calculated interaction flexibility for each species at each site, and included random effects for site and species in our SEM. 

To avoid circularity between traits and the variability measurements, for this part of the study we considered five sites for which we tracked community assembly. Since in these areas the community context is shifting, species are most likely to be variable.

The following code is an excerpt from the *analysis/variability/5piecewiseSEM.R* script for partner variability. For each of or interaction variability we first scaled the variables before fitting them to the model using the `psem` function, with random effect of species and site. We then we evaluated path significance using standardized coefficients. 

```{r, eval=FALSE}
## fit piecewise model with random effect of species and site 
## indirect effect through rdegree, test the effect of cv
partner.var.cv = psem(
  r.degree = lme(r.degree ~ median.abund + median.days + Lecty + MeanITD,
                 random = ~ 1 | Site/GenusSpecies,
                 data = path.variables$partner),
  cv.dist = lme(cv.partner ~ median.abund + median.days+ r.degree  + Lecty + MeanITD,
                random = ~ 1 | Site/GenusSpecies,
                data = path.variables$partner)) 

## To plot
export_graph(plot(partner.var.cv, return = TRUE), 
               file_name = file.path(s.path.fig,"path_MeanPartner.pdf"),file_type = "pdf")
```

Below is the ugly plot provided buy the package, which we then refined in Inkscape to make the Supplementary Figure. 

```{r pressure, echo=FALSE, fig.cap="A caption", out.width = '70%'}
knitr::include_graphics("~/Downloads/path_CVpartner.png")
```
